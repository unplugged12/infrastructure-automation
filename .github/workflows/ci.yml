name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  powershell-lint:
    name: PowerShell Linting
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Lint PowerShell Scripts
        shell: pwsh
        run: |
          $errors = @()
          Get-ChildItem -Path "powershell","scripts" -Filter "*.ps1" -Recurse | ForEach-Object {
            $results = Invoke-ScriptAnalyzer -Path $_.FullName -Severity Error
            if ($results) {
              $errors += $results
            }
          }
          if ($errors.Count -gt 0) {
            $errors | Format-Table -AutoSize
            Write-Error "PSScriptAnalyzer found $($errors.Count) error(s)"
            exit 1
          }

  bash-lint:
    name: Bash Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint Bash Scripts
        run: |
          set -euo pipefail
          find bash scripts -name "*.sh" -type f -print0 | xargs -0 -r shellcheck

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@v0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-scripts:
    name: Validate Script Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PowerShell Syntax
        shell: pwsh
        run: |
          Get-ChildItem -Path "powershell","scripts" -Filter "*.ps1" -Recurse | ForEach-Object {
            try {
              $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $_.FullName -Raw), [ref]$null)
              Write-Host "✓ $($_.Name)" -ForegroundColor Green
            } catch {
              Write-Error "✗ $($_.Name): $_"
              exit 1
            }
          }

      - name: Validate Bash Syntax
        run: |
          find bash scripts -name "*.sh" -type f -exec bash -n {} \;

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check README exists
        run: |
          test -f README.md || (echo "README.md missing" && exit 1)
          test -f LICENSE || (echo "LICENSE missing" && exit 1)
          test -f SECURITY.md || (echo "SECURITY.md missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "CONTRIBUTING.md missing" && exit 1)

      - name: Validate Markdown
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
          config: |
            {
              "MD013": false,
              "MD033": false,
              "MD041": false
            }

  sql-lint:
    name: SQL Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install sqlfluff
        run: |
          python -m pip install --upgrade pip
          pip install sqlfluff==3.0.7

      - name: Lint SQL files
        run: |
          set -euo pipefail
          if find sql -name "*.sql" -type f -print -quit | grep -q .; then
            sqlfluff lint sql
          else
            echo "No SQL files detected, skipping lint."
          fi

  powershell-tests:
    name: PowerShell Tests
    runs-on: windows-latest
    needs: [powershell-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name Pester -ErrorAction Ignore | Where-Object { $_.Version.Major -ge 5 })) {
            Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser
          }

      - name: Run Pester tests
        shell: pwsh
        run: |
          $tests = Get-ChildItem -Path powershell -Filter *.Tests.ps1 -Recurse
          if (-not $tests) {
            Write-Host "No Pester test files found. Skipping suite."
            exit 0
          }

          $resultsPath = Join-Path $PWD 'TestResults'
          New-Item -Path $resultsPath -ItemType Directory -Force | Out-Null

          Invoke-Pester -Script $tests.FullName -Output Detailed -CI -OutputFormat NUnitXml -OutFile (Join-Path $resultsPath 'PesterResults.xml')
          if ($LASTEXITCODE -ne 0) {
            exit $LASTEXITCODE
          }

      - name: Publish Pester results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: pester-results
          path: TestResults/PesterResults.xml
          retention-days: 14
  placeholder-check:
    name: Check for Sanitization Placeholders
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Placeholders Present
        run: |
          set -euo pipefail

          if ! grep -R "<REPLACE_WITH_SECURE_PASSWORD>" powershell/ > /dev/null; then
            echo "ERROR: Password placeholders missing from PowerShell scripts"
            exit 1
          fi

          if ! grep -R "<YOUR_" bash/ > /dev/null; then
            echo "ERROR: Network placeholders missing from Bash scripts"
            exit 1
          fi

          # Fail if any actual company references remain
          if grep -Rni "trojan" . --exclude-dir=.git --exclude-dir=.github; then
            echo "ERROR: Found unsanitized company references"
            exit 1
          fi
